<script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.3/dist/jquery.validate.js"></script>
<div class="wrapper ">
    {{>admin-sidebar}}
    <div class="main-panel">
        {{>admin-navbar}}
        <div class="content">

            <div class="row">
                <div class="col-md-1 col-sm-1 col-1"></div>
                <div class="col-md-10 col-sm-10 col-10">
                    <div class="card ">
                        <div class="card-header card-header-primary">
                            <h4 class="card-title text-center" style="font-weight: bold">OFFER MANAGEMENT</h4>
                        </div>
                        {{#if Msg}}
                        <div>
                            <h5 class="text-center mt-2" style="color:yellowgreen;font-weight:normal">{{Msg}}</h5>
                        </div>
                        {{/if}}
                        {{#if Err}}
                        <div>
                            <h5 class="text-center mt-2" style="color:red;font-weight:normal">{{Err}}</h5>
                        </div>
                        {{/if}}
                        <div class="card-body text-left">

                            <div class="row">
                                <div class="col">

                                    <div class="d-flex justify-content-center ml-3 ">
                                        <button class="btn btn-primary btn-sm" data-toggle="modal"
                                            data-target="#exampleModalCenter"><i
                                                class="material-icons">add_to_photos</i> Add new-offer</button>
                                    </div>

                                    <!-- Modal -->
                                    <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog"
                                        aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                                        <div class="modal-dialog modal-dialog-centered" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h5 class="modal-title" style="font-weight: bold;"
                                                        id="exampleModalCenterTitle">ADD NEW OFFER
                                                    </h5>
                                                    <button type="button" class="close" data-dismiss="modal"
                                                        aria-label="Close">
                                                        <span aria-hidden="true">&times;</span>
                                                    </button>
                                                </div>

                                                <div class="modal-body d-flex justify-content-center">

                                                    <form class="text-center" id="offer-form">
                                                        <label for="offerName" style="color: black;">Offer Name</label>
                                                        <input id="offerName" class="form-control" name="offerName"
                                                            type="text" placeholder="Enter The offer Name"
                                                            style="display: block;color: black;">

                                                        <label for="subCategory" class="mt-4"
                                                            style="color: black;">Offer category</label><br>
                                                        <select style="color: black;" name="subCategory"
                                                            id="subCategory" onchange="checkOfferExist()">

                                                            <option selected disabled>Choose a product</option>
                                                            {{#each Categories}}
                                                            {{#each this.Sub_Cat}}

                                                            <option value="{{this.Sub_Cat}}">
                                                                {{this.Sub_Cat}}</option>

                                                            {{/each}}
                                                            {{/each}}

                                                        </select><br>

                                                        <label for="expiryDate" class="mt-4"
                                                            style="color: black;">Expiry
                                                            Date</label>
                                                        <input id="expiryDate" class="form-control " name="expiryDate"
                                                            type="date" style="display: block;color: black;">

                                                        <label for="offerDiscount" class="mt-4"
                                                            style="color: black;">Discount rate (%)</label>
                                                        <input id="offerDiscount" class="form-control "
                                                            name="offerDiscount" type="number"
                                                            placeholder="Enter the discount rate"
                                                            style="display: block;color: black;">

                                                        <button type="button" class="btn btn-secondary mt-5"
                                                            data-dismiss="modal">Close</button>
                                                        <button id="submitBtn" type="submit" class="btn btn-success mt-5"> Add
                                                            Offer</button>
                                                    </form>

                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <table class="table table-dark" id="myTable">
                                        <thead>
                                            <tr>
                                                <th class="text-center" scope="col">Sl.No</th>
                                                <th class="text-center" scope="col">Offer_Name</th>
                                                <th class="text-center" scope="col">Sub_Category</th>
                                                <th class="text-center" scope="col">Discount(%)</th>
                                                <th class="text-center" scope="col">Created Date</th>
                                                <th class="text-center" scope="col">Expiry Date</th>
                                                <th class="text-center" scope="col">Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>

                                            {{#each offers}}
                                            <tr class="bg-dark">

                                                <td class="text-center bg-dark">{{add @index '1'}}</td>

                                                <td class="text-center">
                                                    {{this.offerName}}
                                                </td>

                                                <td class="text-center">
                                                    {{this.subCategory}}
                                                </td>
                                                <td class="text-center">
                                                    {{this.offerDiscount}}
                                                </td>
                                                <td class="text-center">
                                                    {{this.addedDate}}
                                                </td>
                                                <td class="text-center">
                                                    {{this.expiryDate}}
                                                </td>
                                                <td class="text-center">

                                                    <button
                                                        onclick="confirmDelete('{{this._id}}','{{this.offerName}}','{{this.subCategory}}')"
                                                        type="button" rel="tooltip" title="Remove"
                                                        class="btn btn-white btn-link btn-sm">

                                                        <i class="material-icons">delete</i>

                                                    </button>

                                                </td>

                                            </tr>

                                            {{/each}}

                                        </tbody>
                                    </table>

                                </div>

                            </div>


                        </div>
                    </div>
                </div>

                <div class="col-md-1 col-sm-1 col-1"></div>

            </div>

        </div>



        {{>admin-footer}}

    </div>
</div>



<script>

    function confirmDelete(offerId, offerName, subCat) {
        swal({
            title: "Are you sure?",
            text: `Do you want remove "${offerName}" offer`,
            icon: "warning",
            buttons: true,
            dangerMode: true,
        }).then((confirmed) => {
            if (confirmed) {
                $.ajax({
                    url: "/admin/delete-offer?offerId=" + offerId + "&subCat=" + subCat,
                    method: "post",
                    success: (status) => {
                        swal("Deleted!", "The offer has been removed!", "success", {
                            button: "OK",
                        }).then(() => {
                            location.reload()
                        })
                    }
                })
            }
        })
    }

    function checkOfferExist(){

       let subCat =document.getElementById('subCategory').value

        $.ajax({

            url:'/admin/check-offer-exist?subCat='+subCat,
            method:'get',
            success:(response)=>{
                if(response){
                    swal("Alert!", `Offer already exist for the selected category!`, "warning");
                    document.getElementById('submitBtn').style.display='none'
                }else{
                    
                    document.getElementById('submitBtn').style.display='inline'
                }
            }

        })

    }

</script>

<script>

    $(document).ready(function () {

        $('#offer-form').validate({

            rules: {

                offerName: {
                    required: true,
                    minlength: 4,
                    maxlength: 15
                },

                subCategory: {
                    required: true
                },

                expiryDate: {
                    required: true
                },

                offerDiscount: {
                    required: true,
                    maxlength: 2
                }

            },

            messages: {

                offerName: {
                    required: "Please enter the offer name",
                    minlength: "Offer name too short",
                    maxlength: "Offer name too long"
                },

                subCategory: {
                    required: "Please choose a offer category"
                },

                expiryDate: {
                    required: "Please set an expiry date"
                },

                offerDiscount: {
                    required: "Please enter the discount rate",
                    maxlength: "Invalid discount rate"
                }

            },

            submitHandler: function () {

                $.ajax({

                    url: '/admin/add-new-offer',
                    method: 'post',
                    data: $('#offer-form').serialize(),
                    success: (response) => {

                        swal("Success!", "Added new offer!", "success", {
                            button: "OK",
                        }).then(() => {
                            location.reload()
                        })

                    }

                })

            }
        })

    })

</script>

<style>
    .error {
        color: red !important;
        font-size: small !important;

    }

    .table thead tr th {
        font-weight: bold;

    }
</style>

{{!-- data tables --}}
<link rel="stylesheet" type="text/css"
    href="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.0/css/jquery.dataTables.css">

<link rel="stylesheet" type="text/css"
    href="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.0/css/jquery.dataTables_themeroller.css">

<script type="text/javascript" charset="utf8" src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.7.1.min.js"></script>

<script type="text/javascript" charset="utf8"
    src="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.0/jquery.dataTables.min.js" defer></script>

<script>

    $(document).ready(function () {
        $('#myTable').DataTable();
    });myTable

</script>

